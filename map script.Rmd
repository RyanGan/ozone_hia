```{r}
#load required packages

library(ggplot2)
library(maptools)
library(RColorBrewer)
library(sp)
library(maps)
library(rgdal)
library(raster)
library(plyr)
library(dplyr)
library(tidyverse)

setwd("C:/Users/Jake/Desktop")
#upload datasets

total_path <- paste0('./data/mc_estimates/rates/total_hia.csv')
# import csv and make sure variables as numeric like they should be
total <- read_csv(total_path)
str(total)

white_path <- paste0('./data/mc_estimates/rates/white_hia.csv')
# import csv and make sure variables as numeric like they should be
white <- read_csv(white_path)

hisp_path <- paste0('./data/mc_estimates/rates/hisp_hia.csv')
# import csv and make sure variables as numeric like they should be
hisp <- read_csv(hisp_path)

black_path <- paste0('./data/mc_estimates/rates/black_hia.csv')
# import csv and make sure variables as numeric like they should be
black <- read_csv(black_path)

male_path <- paste0('./data/mc_estimates/rates/male_hia.csv')
# import csv and make sure variables as numeric like they should be
male <- read_csv(male_path)

female_path <- paste0('./data/mc_estimates/rates/female_hia.csv')
# import csv and make sure variables as numeric like they should be
female <- read_csv(female_path)

#Set a list of dataframes to loop through
df_list <- list(hisp=hisp, total=total, female=female, black=black, white=white, male=male)
df_name <- c('hisp', 'total', 'female', 'black', 'white', 'male')

#Get map shapefiles
 
# read zip code polygon shapefile for entire US.

bound_dir <- paste0("C:\\Users\\Jake\\Desktop\\state_shape_file\\", "\\gz_2010_us_040_00_500k")

zip <- readOGR(dsn = bound_dir, layer = 'gz_2010_us_040_00_500k')

#summary(zip)
 
states <- readOGR(dsn = bound_dir, layer = 'gz_2010_us_040_00_500k')

#plot(states)

states@data$id <- rownames(states@data)

 
states_df <- fortify(states) # convert to data frame suitable for plotting

states_df <- join(states_df, states@data, by="id")


names(states_df)[names(states_df)=="STATE"] <- 'state_num'

states_df$state_num <- as.numeric(states_df$state_num)


#Get rid of Alaksa and Hawaii

states_df <- states_df[!(states_df$state_num == 2),]
states_df <- states_df[!(states_df$state_num == 12),]

#Merge and restrict lat and long

choro_white <- merge(states_df, white, by = "state_num")

choro_white <- choro_white[choro_white$long > -124.848 &
                 choro_white$long < -66.886 &
                 choro_white$lat > 24.3964 &
                 choro_white$lat < 49.3844, ]

choro_white$median <- as.numeric(choro_white$median)

#Make a Map


choro_white <- choro_white[order(choro_white$order), ]
fortify(choro_white, region='state')
  
ggplot(choro_white, aes(long, lat)) +
    geom_polygon(aes(group = group, fill = choro_white$median)) +
    coord_map("albers",  at0 = 45.5, lat1 = 29.5)+
    scale_fill_gradientn(name="ED Visits",
                               colours=brewer.pal(9,"Reds"))+
  theme(legend.title = element_text(size = rel(4)))+
  theme(legend.text = element_text(size = rel(4)))+
  theme(legend.key.size = unit(2, "cm"))+
  geom_path(aes(group = group, fill = choro_white$median)) +
    coord_map("albers",  at0 = 45.5, lat1 = 29.5)+
labs(title = "Median Estimated Asthma ED Visits Due to WF03 in Children From \n2005 to 2013 per 100,000 Children With Asthma (white)")+
#labs(title = "Median Estimated Asthma ED Visits Due to WF03 in Children From 2005 to 2013 (white)")+
theme(plot.title = element_text(size = rel(3)))+
theme(panel.background = element_rect(fill = "white"))


``` 

